<!DOCTYPE html>
<html lang="es">

<head>

	<title>8.4Leaflet</title>
	<link rel="stylesheet" href="lib/leaflet/leaflet.css" />
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB"
	 crossorigin="anonymous">
	<script src="lib/leaflet/leaflet.js"></script>

	<link rel="stylesheet" href="lib/leaflet-groupedlayercontrol/dist/leaflet.groupedlayercontrol.min.css" />
	<script src="lib/leaflet-groupedlayercontrol/dist/leaflet.groupedlayercontrol.min.js"></script>

	<!--  Nuevas librerías para el manejo de formulario   -->
	<!-- https://getbootstrap.com/docs/4.1/getting-started/introduction/ -->
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
	 crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T"
	 crossorigin="anonymous"></script>

	 <style>
		 #mapid{
			 margin-top: 55px
		 }
	 </style>

</head>

<body>
		<nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light">
				<a class="navbar-brand" href="#">Luis Alfonso Cardona</a>
				<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
			
				<div class="collapse navbar-collapse" id="navbarSupportedContent">
					<ul class="navbar-nav mr-auto">
						<li class="nav-item active">
							<a class="nav-link" href="#">Inicio <span class="sr-only">(current)</span></a>
						</li>

						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								Agregar Geometria
							</a>
							<div class="dropdown-menu" aria-labelledby="navbarDropdown">
								<a class="dropdown-item" href="#">Agregar hueco</a>
								<a class="dropdown-item" href="#">Agregar semaforo </a>
								<div class="dropdown-divider"></div>
								<a class="dropdown-item" href="#">Agregar otro</a>
							</div>
						</li>
					</ul>
					
				</div>
			</nav>

	<div id="mapid" style="width: 1000px; height: 680px;">
	</div>
	<br>
	<!--  *******************   Capturar coord. **********************-->

	<button id="botonformulario" type="button" class="btn btn-primary">
		Capturar coord.
	</button>
	<br>
	<br>
	<br>
	<br>
	<div class="modal fade" id="formulariomodal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">
						<p id="titulomodal"></p>
					</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">

					<form>

						<div class="form-group">
							<label for="input_lat">Latitud:</label>
							<input type="text" class="form-control" id="input_lat" aria-describedby="emailHelp" placeholder="">
						</div>

						<div class="form-group">
							<label for="input_long">Longitud:</label>
							<input type="text" class="form-control" id="input_lon" placeholder="">
						</div>

						<div class="form-group">
							<label for="input_nom">Nombre:</label>
							<input type="text" class="form-control" id="input_nom" placeholder="">
						</div>

						<div class="form-group">
							<label for="input_fecha">Fecha:</label>
							<input type="date" class="form-control" id="input_fecha" placeholder="">
						</div>

						<div class="form-group">
							<label for="input_tipo">Tipo</label>
							<select class="form-control" id="input_tipo">
								<option value="H">Hueco</option>
								<option value="R">Robo</option>
								<option value="D">Daños</option>
								<option value="S">Semaforo</option>

							</select>
						</div>

						<div class="form-group">
							<label for="input_desc">Descripcion:</label>
							<input type="text" class="form-control" id="input_desc" placeholder="">
						</div>

						<div class="form-group">
							<label for="input_foto">Foto</label>
							<input type="file" class="form-control-file" id="input_foto" accept="image/*">
						</div>

					</form>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary" id="enviarform">Enviar Formulario</button>
				</div>
			</div>

		</div>
	</div>


	<script>


		var basemaps =
		{
			Grayscale: L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png',
				{
					maxZoom: 18,
					attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
				}),

			Streets: L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
				{
					maxZoom: 19,
					attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
				})
		};

		var mymap = L.map('mapid').setView([3.9610648, -76.5363028], 9);

		var wmsLayer1 = L.tileLayer.wms('http://localhost:8080/geoserver/wms?', {
			layers: 'Clase10_sig3:vallell',
			attribution: 'Municipios Valle',
			format: 'image/png',
			transparent: true
		});

		var wmsLayer2 = L.tileLayer.wms('http://idesc.cali.gov.co:8081/geoserver/wms?', {
			layers: 'idesc:mc_manzanas',
			attribution: 'Manzanas Cali',
			format: 'image/png',
			transparent: true
		});

		var wmsLayer3 = L.tileLayer.wms('http://localhost:8080/geoserver/wms?', {
			layers: 'Clase10_sig3:barrios',
			attribution: 'Barrios Cali',
			format: 'image/png',
			transparent: true
		});

		var wmsLayer4 = L.tileLayer.wms('http://localhost:8080/geoserver/wms?', {
			layers: 'Clase10_sig3:viasvalle2ll',
			attribution: 'Vias Cali',
			format: 'image/png',
			transparent: true
		});

		basemaps.Grayscale.addTo(mymap);
		wmsLayer1.addTo(mymap);
		wmsLayer2.addTo(mymap);
		wmsLayer3.addTo(mymap);
		wmsLayer4.addTo(mymap);


		var groupedOverlays = {
			"Capas Municipio": {
				"Manzanas": wmsLayer2
			}
			,
			"Capas propias": {
				"Munivipios": wmsLayer1,
				"Barrios": wmsLayer3,
				"Vias departamentales": wmsLayer4
			}
		};

		L.control.groupedLayers(basemaps, groupedOverlays).addTo(mymap);

		var popup = L.popup();

		function onMapClick(e) {

			var lat = e.latlng.lat.toFixed(5);
			var lon = e.latlng.lng.toFixed(5);

			$('#formulariomodal').modal();

			$("#titulomodal").text("Formulario para (" + lat + "," + lon + ")");

			$("#input_lat").val(lat);
			$("#input_lat").prop('disabled', true);

			$("#input_lon").val(lon);
			$("#input_lon").prop('disabled', true);

			var now = new Date();
			var day = ("0" + now.getDate()).slice(-2);
			var month = ("0" + (now.getMonth() + 1)).slice(-2);
			var today = now.getFullYear() + "-" + (month) + "-" + (day);
			$('#input_fecha').val(today);

		}



		$("#botonformulario").on("click", function () {

			mymap.once('click', onMapClick);

		})


		$("#enviarform").on("click", function () {



			var lat = $("#input_lat").val();
			var lon = $("#input_lon").val();
			var nom = $("#input_nom").val();
			var tip = $("#input_tipo").val();
			var fecha = $("#input_fecha").val();
			var desc = $("#input_desc").val();

			function getBase64(file) {
				var reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = function () {
					var base64 = reader.result;
					lecturadatos(base64);


				};
				reader.onerror = function (error) {
					console.log('Error: ', error);
				};
			}

			var file = document.getElementById('input_foto').files[0];

			if (file) {
				getBase64(file);
			} else {
				lecturadatos('Sin Foto')
			}

			function lecturadatos(img) {

				var datos = {
					lat: lat,
					lon: lon,
					nom: nom,
					tip: tip,
					fecha: fecha,
					desc: desc,
					foto: img
				};

				console.log(img);



				$.ajax({
					url: "php/agregar.php",
					type: "post",
					data: datos,
					success: function (response) {
						console.log(response);
						window.location.reload(true);

					},
					error: function (jqXHR, textStatus, errorThrown) {
						console.log(textStatus, errorThrown);
					}


				});


			}

		})


	</script>

</body>

</html>